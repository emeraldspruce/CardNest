{% extends 'base.html' %}

{% block title %}Login{% endblock %}

{% block body %}
<h2 class="login-form">Login</h2>
<form id="login-form" class="needs-validation" novalidate>
    <div class="mb-3">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" class="form-control" id="email" required/>
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" required/>
    </div>
    <div class="mb-3">
    <button type="submit" class="btn btn-primary">Login</button>
    <button type="button" id="signup-btn" class="btn btn-secondary">Create Account</button>
    <a href="#" id="forgot-password" class="btn btn-link">Forgot password?</a>
    </div>
    <div class="auth-status mt-3 text-danger"></div>

</form>





{% endblock %}
{% block scripts %}
<!-- Firebase compat libraries -->

    <script>

    // Get DOM references
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const signupBtn = document.getElementById("signup-btn");
    const authStatus = document.querySelector(".auth-status");
    const loginForm = document.getElementById("login-form");

    // --- HELPER FUNCTION TO CREATE SERVER SESSION ---
    // This function sends the token to Flask and handles the redirect
    async function createServerSessionAndRedirect(user) {
        // You can show a loading message if you want
        authStatus.innerText = "Signing you in...";
        authStatus.classList.remove('text-danger');

        try {
            const idToken = await user.getIdToken();
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken }),
            });

            const data = await response.json();

            // Check if the server successfully created the session
            if (response.ok && data.status === 'success') {
                // NOW it's safe to redirect to the URL the server sent
                window.location.href = data.redirect;
            } else {
                authStatus.innerText = data.message || "Server login failed.";
                authStatus.classList.add('text-danger');
            }
        } catch (error) {
            console.error('Error creating server session:', error);
            authStatus.innerText = "A connection error occurred.";
            authStatus.classList.add('text-danger');
        }
    }

    // --- FIREBASE AUTH STATE LISTENER ---
    // Checks if a user is already signed in on the browser
    auth.onAuthStateChanged((user) => {
        const path = window.location.pathname;
        if (user && (path === '/login' || path === '/')) {
            // User is logged into Firebase and on the login page.
            // Create the server session before doing anything else.
            createServerSessionAndRedirect(user);
        } else {
            // User is not logged in, do nothing, let them see the form.
            console.log('No active Firebase session.');
        }
    });
    // Login
   loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
        authStatus.innerHTML = "Please enter both email and password.";
        return;
    }
    try {
        const user = await auth.signInWithEmailAndPassword(email, password);
        const idToken = await user.user.getIdToken();
        await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken })
        });
        window.location.href = "/dashboard";
    } catch (err) {
        authStatus.innerHTML = getFriendlyErrorMessage(err.code);
    }
});

    // --- CLICK HANDLER FOR SIGNUP ---
    signupBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
            authStatus.innerText = "Please enter both email and password to sign up.";
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            // After successful signup, create the server session
            await createServerSessionAndRedirect(userCredential.user);
        } catch (err) {
            // Handle Firebase client-side errors (e.g., email in use)
            authStatus.innerText = `Signup failed: ${err.message}`;
        }
    });

    // Add your "Forgot Password" logic here if needed

</script>
{% endblock %}